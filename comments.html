<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>WhoWatch コメント（新しい→上／左30%・縦80%）</title>
<style>
  html,body{margin:0;background:#0b0b0b;color:#fff;font-family:sans-serif;height:100%}
  /* 左端の固定ウィンドウ */
  #panel{
    position:fixed; left:0; top:10vh;   /* 画面上から10%下げる→高さ80%とセット */
    width:30vw; height:80vh;            /* 横30% × 縦80% */
    box-sizing:border-box;
    padding:10px 12px;
    background:rgba(0,0,0,.55);
    border-right:1px solid #333;
    overflow-y:auto;                     /* 中はスクロール可 */
    /* ↓ スクロールバーを非表示（主要ブラウザ対応） */
    scrollbar-width: none;               /* Firefox */
    -ms-overflow-style: none;            /* IE/Edge旧 */
  }
  #panel::-webkit-scrollbar{ width:0; height:0 } /* Chrome/Safari/Edge */

  /* 見出しや状態は非表示 */
  #title, #status { display:none; }

  /* リスト（上＝最新） */
  ul#list{list-style:none; padding:0; margin:0}
  ul#list li{
    margin:8px 0; padding:8px 10px;
    background:rgba(0,0,0,.6);
    border-left:4px solid #ffeb66;
    border-radius:10px;
  }
  .user{font-weight:700}
  .msg{white-space:pre-wrap; word-break:break-word}
  .meta{font-size:11px; opacity:.7; margin-top:4px}

  /* エラー表示（不要なら display:none; にしてOK） */
  #err{color:#ff8a8a; font-size:12px; white-space:pre-wrap; margin:4px 0 8px; display:none;}
</style>
</head>
<body>
<div id="panel">
  <div id="title">最新コメント（上＝最新）</div>
  <div id="status">初期化中…</div>
  <div id="err"></div>
  <ul id="list"></ul>
</div>

<script>
/* ===== 設定 ===== */
const USER        = "rarirure69n66";
const GISTID      = "5697ca0fe833531c03c10ba6950f7d3e";
const POLL_MS     = 1500;
const WORKER_BASE = "https://whowatch-relay.win3100c.workers.dev/ww/lives/"; // 末尾 /
/* ============== */

const RAW_GIST = `https://gist.githubusercontent.com/${USER}/${GISTID}/raw/current.txt`;
const API_GIST = `https://api.github.com/gists/${GISTID}`;

const elList   = document.getElementById('list');
const elErr    = document.getElementById('err');

function setStatus(_){/* 非表示 */}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* URL→id抽出＆プロキシURL生成 */
function buildApiUrlFromSource(u){
  const s=(u||"").trim();
  let m = s.match(/^https?:\/\/api\.whowatch\.tv\/lives\/(\d+)/);
  if(!m) m = s.match(/whowatch\.tv\/(?:lives|viewer)\/(\d+)/);
  if(!m) m = s.match(/r\.whowatch\.tv\/lives\/(\d+)/);
  if(!m) return null;
  const id = m[1];
  return { id, url: `${WORKER_BASE}${id}?last_updated_at=` };
}

/* Gist読み（API優先→RAWフォールバック） */
async function readGistText(){
  try{
    const res = await fetch(API_GIST, { headers: { "Accept":"application/vnd.github+json" }, cache: "no-store" });
    if(!res.ok) throw new Error(`Gist API ${res.status}`);
    const j = await res.json();
    const f = j.files?.["current.txt"];
    if (!f) throw new Error("Gistに current.txt がありません");
    if (f.truncated === false && typeof f.content === "string") return f.content.trim();
    if (f.raw_url) {
      const r = await fetch(f.raw_url + "?t=" + Date.now(), { cache:"no-store" });
      if(!r.ok) throw new Error(`Gist RAW ${r.status}`);
      return (await r.text()).trim();
    }
    throw new Error("Gistファイルを読めません（raw_urlなし）");
  }catch(e){
    const r = await fetch(RAW_GIST + "?t=" + Date.now(), { cache:"no-store" });
    if(!r.ok) throw new Error(`Gist RAW ${r.status} / ${e.message}`);
    return (await r.text()).trim();
  }
}

/* 表示：先頭に追加（＝最新が一番上） */
function prependComment(c){
  const li = document.createElement('li');
  const user = c?.user?.name ?? c?.user_name ?? "匿名";
  const msg  = c?.message ?? c?.escaped_message ?? c?.text ?? c?.body ?? "(メッセージなし)";
  const ts   = typeof c?.posted_at === "number"
                ? new Date(c.posted_at).toLocaleString()
                : (c?.created_at || c?.updated_at || c?.time || "");
  li.innerHTML =
    `<div class="user">${escapeHtml(user)}</div>` +
    `<div class="msg">${escapeHtml(msg)}</div>` +
    `<div class="meta">${escapeHtml(ts)}</div>`;
  elList.insertBefore(li, elList.firstChild); // ← 先頭に入れる＝最新が上
  // 件数制限：古い方（末尾）から削除
  const MAX = 80;
  while (elList.childElementCount > MAX) elList.removeChild(elList.lastChild);
}

/* ===== 変換＋ポーリング ===== */
let apiUrl = "";
let liveId = "";
let lastCur = null;        // 初回はリセット（全取得）
let etag   = null;
let seen   = new Set();    // 重複防止

function idOf(c){
  return c?.id ?? `${c?.user?.id||c?.user_id||"u"}-${c?.posted_at||c?.created_at||c?.updated_at||Math.random()}`;
}

async function init(){
  const txt = await readGistText();
  const first = (txt.split(/\r?\n/).map(s=>s.trim()).find(Boolean)) || "";
  const built = buildApiUrlFromSource(first);
  if (!built) throw new Error("対応外URL: " + first);
  apiUrl  = built.url;
  liveId  = built.id;
  lastCur = null; // リセットして最初から
}

async function pollOnce(){
  const url = apiUrl + encodeURIComponent(lastCur || "");
  const headers = {"cache-control":"no-store"};
  if(etag) headers["If-None-Match"] = etag;

  const res = await fetch(url, { headers });
  if(res.status === 304){ return; }
  if(!res.ok) throw new Error(`WhoWatch ${res.status}`);

  etag = res.headers.get("etag") || etag;
  const json = await res.json();

  // コメント配列（comments / data / 自動探索の保険）
  let arr = Array.isArray(json.comments) ? json.comments
          : Array.isArray(json.data)     ? json.data
          : null;
  if(!arr){
    const find = (obj, depth=0) => {
      if(depth>3 || !obj) return null;
      if(Array.isArray(obj)){
        const score = obj.slice(0,5).reduce((n,it)=> n + (it && (it.message||it.text||it.body) ? 1:0), 0);
        return score>=2 ? obj : null;
      }
      if(typeof obj === "object"){
        for(const k of Object.keys(obj)){ const f=find(obj[k], depth+1); if(f) return f; }
      }
      return null;
    };
    arr = find(json);
  }

  if(Array.isArray(arr) && arr.length){
    // 古→新に並べ替え（=時系列）
    arr.sort((a,b)=>{
      const ta = (typeof a.posted_at==="number") ? a.posted_at : +new Date(a.created_at||a.updated_at||0);
      const tb = (typeof b.posted_at==="number") ? b.posted_at : +new Date(b.created_at||b.updated_at||0);
      return ta - tb;
    });

    // 未表示のものだけ取得し、時系列のまま「先頭に挿入」。
    // ※ oldest→newest の順で prepend すると、最後に処理した newest が最上段になる
    const newly = [];
    for(const c of arr){
      const id = idOf(c);
      if(seen.has(id)) continue;
      seen.add(id);
      newly.push(c);
    }
    for(const c of newly){ prependComment(c); }

    // カーソル更新（サーバ返却を優先）
    let nextCur = json.last_updated_at || json.cursor || null;
    if(!nextCur && arr.length){
      const last = arr[arr.length-1];
      if (typeof last.posted_at === "number") nextCur = new Date(last.posted_at).toISOString();
      else {
        const t = last.created_at || last.updated_at || last.time;
        nextCur = t ? new Date(t).toISOString() : null;
      }
    }
    if(nextCur) lastCur = String(nextCur);
  }
}

async function loop(){
  while(true){
    try{ await pollOnce(); elErr.textContent=""; }
    catch(e){ elErr.textContent = `poll失敗: ${e.message}`; }
    await new Promise(r=>setTimeout(r, POLL_MS));
  }
}

(async function main(){
  try{
    await init();
    await pollOnce();
    loop();
  }catch(e){
    elErr.textContent = `初期化失敗: ${e.message}`;
  }
})();
</script>
</body>
</html>
