<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>WhoWatch URLコンバータ → API表示</title>
  <style>
    html,body{margin:0;padding:0;background:#0b0b0b;color:#fff;font-family:sans-serif}
    .wrap{padding:16px}
    h1{font-size:18px;margin:0 0 12px}
    .small{opacity:.7;font-size:12px}
    .box{background:#111;border:1px solid #333;border-radius:10px;padding:12px;margin:8px 0;word-break:break-all}
    .label{font-size:12px;opacity:.8;margin-bottom:6px}
    .api{font-size:14px}
    .error{color:#ff8a8a}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WhoWatch URL → API URL 変換</h1>
    <div class="small">Gist: <span id="gist-url"></span></div>

    <div class="box">
      <div class="label">Gist内の元URL（複数行OK）</div>
      <div id="raw" class="small"></div>
    </div>

    <div class="box">
      <div class="label">変換結果（API URL）</div>
      <div id="converted" class="api"></div>
    </div>

    <div id="err" class="error"></div>
  </div>

  <script>
    // ====== 設定（ここを差し替え）======
    const USER   = "rarirure69n66";     // 例: rarirure69n66
    const GISTID = "5697ca0fe833531c03c10ba6950f7d3e";  // 例: 1a2b3c4d5e6f7...
    // ==================================

    const RAW_GIST = `https://gist.githubusercontent.com/${USER}/${GISTID}/raw/current.txt`;

    document.getElementById('gist-url').textContent = RAW_GIST;

    function convertToApiUrl(u) {
      if (!u) return "";
      const s = u.trim();

      // すでにAPI形式ならそのまま（last_updated_atは残す/付け直す）
      const mApi = s.match(/^https?:\/\/api\.whowatch\.tv\/lives\/(\d+)(?:\?.*)?$/);
      if (mApi) {
        return `https://api.whowatch.tv/lives/${mApi[1]}?last_updated_at=`;
      }

      // /lives/<id> または /viewer/<id> から抽出
      const m = s.match(/whowatch\.tv\/(?:lives|viewer)\/(\d+)/);
      if (m) {
        const id = m[1];
        return `https://api.whowatch.tv/lives/${id}?last_updated_at=`;
      }

      // r.whowatch.tv の /lives/<id>/share 形式
      const mR = s.match(/r\.whowatch\.tv\/lives\/(\d+)/);
      if (mR) {
        return `https://api.whowatch.tv/lives/${mR[1]}?last_updated_at=`;
      }

      // マッチしなかったらそのまま返す（エラー表示用）
      return s;
    }

    async function tick() {
      const err = document.getElementById('err');
      err.textContent = "";

      try {
        const res = await fetch(RAW_GIST + "?t=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error(`Gist取得失敗: ${res.status}`);
        const txt = (await res.text()).trim();

        // 元URLを表示
        document.getElementById('raw').textContent = txt || "(空です)";

        // 行ごとに分解して変換
        const lines = txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        const converted = lines.map(convertToApiUrl);

        // 変換結果の表示
        const convDiv = document.getElementById('converted');
        convDiv.innerHTML = converted.length
          ? converted.map(u => `<div>${escapeHtml(u)}</div>`).join("")
          : "(有効なURLが見つかりませんでした)";

        // 変換できていない行があるか軽くチェック
        const notConverted = converted.filter((u,i)=>!/^https?:\/\/api\.whowatch\.tv\/lives\/\d+\?last_updated_at=$/.test(u));
        if (notConverted.length) {
          err.textContent = "一部の行はAPI形式に変換できませんでした。書式を確認してください。";
        }

      } catch (e) {
        err.textContent = e.message;
      }
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    tick();
    // 必要なら定期更新（Gistの手動更新に追従）
    setInterval(tick, 2000);
  </script>
</body>
</html>
