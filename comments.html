<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>WhoWatch URL → API変換 + 最新コメント表示 (debug)</title>
  <style>
    html,body{margin:0;padding:0;background:#0b0b0b;color:#fff;font-family:sans-serif}
    .wrap{padding:16px}
    h1{font-size:18px;margin:0 0 12px}
    .small{opacity:.7;font-size:12px}
    .box{background:#111;border:1px solid #333;border-radius:10px;padding:12px;margin:8px 0;word-break:break-all}
    .label{font-size:12px;opacity:.8;margin-bottom:6px}
    .api{font-size:14px}
    .error{color:#ff8a8a;white-space:pre-wrap}
    .row{margin:6px 0;padding:10px 14px;background:rgba(0,0,0,.6);
         border-left:4px solid #ffeb66;border-radius:10px;max-width:92vw}
    .meta{opacity:.7;font-size:12px;margin-top:4px}
    #status{opacity:.7;font-size:12px;margin-top:6px}
    code{background:#222;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WhoWatch URL → API URL 変換</h1>

    <div class="box">
      <div class="label">Gistエンドポイント</div>
      <div class="small">API: <span id="gist-api"></span></div>
      <div class="small">RAW: <span id="gist-raw"></span></div>
    </div>

    <div class="box">
      <div class="label">Gist内の元URL（複数行OK）</div>
      <div id="raw" class="small"></div>
    </div>

    <div class="box">
      <div class="label">変換結果（API URL）</div>
      <div id="converted" class="api"></div>
    </div>

    <div class="box">
      <div class="label">最新コメント（初回はリセット＝全取得→以後は増分）</div>
      <div id="latest" class="row">待機中…</div>
      <div id="status"></div>
    </div>

    <div id="err" class="error"></div>
  </div>

  <script>
    // === あなたの値 ===
    const USER   = "rarirure69n66";
    const GISTID = "5697ca0fe833531c03c10ba6950f7d3e";
    const POLL_MS = 1500;
    // ================

    const RAW_GIST = `https://gist.githubusercontent.com/${USER}/${GISTID}/raw/current.txt`;
    const API_GIST = `https://api.github.com/gists/${GISTID}`;
    document.getElementById('gist-api').textContent = API_GIST;
    document.getElementById('gist-raw').textContent = RAW_GIST;

    const elErr = document.getElementById('err');
    const elRaw = document.getElementById('raw');
    const elConv = document.getElementById('converted');
    const elLatest = document.getElementById('latest');
    const elStatus = document.getElementById('status');

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function setStatus(msg){ elStatus.textContent = msg; }

    function convertToApiUrl(u){
      if(!u) return "";
      const s=u.trim();
      let m = s.match(/^https?:\/\/api\.whowatch\.tv\/lives\/(\d+)/);
      if(m) return `https://api.whowatch.tv/lives/${m[1]}?last_updated_at=`;
      m = s.match(/whowatch\.tv\/(?:lives|viewer)\/(\d+)/);
      if(m) return `https://api.whowatch.tv/lives/${m[1]}?last_updated_at=`;
      m = s.match(/r\.whowatch\.tv\/lives\/(\d+)/);
      if(m) return `https://api.whowatch.tv/lives/${m[1]}?last_updated_at=`;
      return s;
    }

    function showLatest(c){
      const user = c?.user?.name ?? c?.user_name ?? "匿名";
      const text = c?.text ?? c?.body ?? JSON.stringify(c);
      const t    = c?.created_at || c?.updated_at || c?.time || "";
      elLatest.innerHTML = `<div><strong>${escapeHtml(user)}</strong>：${escapeHtml(text)}</div><div class="meta">${escapeHtml(t)}</div>`;
    }

    // ---- Gist読み（API→RAW フォールバック）----
    async function readGistText(){
      // 1) API経由
      try{
        const res = await fetch(API_GIST, {
          headers: { "Accept":"application/vnd.github+json", "Cache-Control":"no-cache" }
        });
        if(!res.ok) throw new Error(`API ${res.status}`);
        const j = await res.json();
        const f = j.files?.["current.txt"];
        if(!f) throw new Error("current.txt が無い");
        if (f.truncated===false && typeof f.content==="string") {
          return f.content.trim();
        } else if (f.raw_url) {
          const r = await fetch(f.raw_url + "?t=" + Date.now(), { cache:"no-store" });
          if(!r.ok) throw new Error(`raw_url ${r.status}`);
          return (await r.text()).trim();
        } else {
          throw new Error("raw_url なし");
        }
      }catch(e){
        // 2) RAW直（file://で失敗する場合あり）
        elErr.textContent = `Gist(API)失敗: ${e.message}\n→ RAWで再試行します`;
        try{
          const r = await fetch(RAW_GIST + "?t=" + Date.now(), { cache:"no-store" });
          if(!r.ok) throw new Error(`RAW ${r.status}`);
          return (await r.text()).trim();
        }catch(e2){
          throw new Error(`Gist(RAW)失敗: ${e2.message}`);
        }
      }
    }

    // ---- 変換 + ポーリング ----
    let apiUrl = "";    // https://api.whowatch.tv/lives/<id>?last_updated_at=
    let liveId = "";
    let lastCur = null; // 初回はリセット（全取得）
    let etag   = null;

    async function init(){
      elErr.textContent = "";
      setStatus("初期化中…");
      const txt = await readGistText();
      elRaw.textContent = txt || "(空です)";
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const converted = lines.map(convertToApiUrl);
      elConv.innerHTML = converted.length
        ? converted.map(u=>`<div>${escapeHtml(u)}</div>`).join("")
        : "(有効なURLが見つかりませんでした)";
      const picked = converted.find(u=>/^https?:\/\/api\.whowatch\.tv\/lives\/\d+\?last_updated_at=$/.test(u));
      if(!picked) throw new Error("API URLに変換できる行がありません");
      apiUrl = picked;
      liveId = (picked.match(/lives\/(\d+)\?/)||[])[1] || "";
      lastCur = null; // ページ入場でリセット
      setStatus(`開始 live:${liveId} last:<全取得>`);
    }

    async function pollOnce(){
      const url = apiUrl + encodeURIComponent(lastCur||"");
      const headers = {"cache-control":"no-cache"};
      if(etag) headers["If-None-Match"]=etag;

      const res = await fetch(url, { headers });
      if(res.status===304){ setStatus(`304 Not Modified / last:${lastCur||"<全取得>"}`); return; }
      if(!res.ok) throw new Error(`WhoWatch ${res.status}`);
      etag = res.headers.get("etag") || etag;
      const json = await res.json();
      const arr = Array.isArray(json.comments) ? json.comments : (json.data||[]);
      if(Array.isArray(arr) && arr.length){
        arr.sort((a,b)=> new Date(a.created_at||a.updated_at||0) - new Date(b.created_at||b.updated_at||0));
        const latest = arr[arr.length-1];
        showLatest(latest);
        let nextCur = json.last_updated_at || json.cursor || null;
        if(!nextCur){
          const t = latest.created_at || latest.updated_at || latest.time;
          nextCur = t ? new Date(t).toISOString() : null;
        }
        if(nextCur) lastCur = String(nextCur);
      }
      setStatus(`OK live:${liveId} last:${lastCur||"<全取得>"}`);
    }

    async function loop(){
      while(true){
        try{ await pollOnce(); }
        catch(e){ elErr.textContent = `poll失敗: ${e.message}`; }
        await new Promise(r=>setTimeout(r, POLL_MS));
      }
    }

    (async function main(){
      try{
        await init();
        await pollOnce();
        loop();
      }catch(e){
        elErr.textContent = `初期化失敗: ${e.message}\n\n【ヒント】\n- GistはPublicか？\n- current.txtは存在するか？(綴り)\n- 可能なら http://localhost で開く\n- Networkタブで失敗URLを確認`;
        setStatus("初期化失敗");
      }
    })();
  </script>
</body>
</html>
