<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>WhoWatch コメント（新しい→上／左30%・縦80%／安全なIMG表示）</title>
<style>
  html,body{margin:0;background:#0b0b0b;color:#fff;font-family:sans-serif;height:100%}
  #panel{
    position:fixed; left:0; top:10vh;
    width:30vw; height:80vh;
    box-sizing:border-box; padding:10px 12px;
    background:rgba(0,0,0,.55); border-right:1px solid #333;
    overflow-y:auto; scrollbar-width:none; -ms-overflow-style:none;
  }
  #panel::-webkit-scrollbar{ width:0; height:0 }

  #title, #status{ display:none; }
  ul#list{list-style:none; padding:0; margin:0}
  ul#list li{
    margin:8px 0; padding:8px 10px;
    background:rgba(0,0,0,.6);
    border-left:4px solid #ffeb66; border-radius:10px;
  }
  .user{font-weight:700}
  .msg{white-space:pre-wrap; word-break:break-word}
  .meta{font-size:11px; opacity:.7; margin-top:4px}
  /* 絵文字IMGの見た目を統一（style属性は捨てるため） */
  .msg img.emoji{ vertical-align:text-bottom; width:1.5em; height:1.5em; }
  #err{display:none;}
</style>
</head>
<body>
<div id="panel">
  <div id="title">最新コメント（上＝最新）</div>
  <div id="status">初期化中…</div>
  <div id="err"></div>
  <ul id="list"></ul>
</div>

<script>
/* ===== 設定 ===== */
const USER        = "rarirure69n66";
const GISTID      = "5697ca0fe833531c03c10ba6950f7d3e";
const POLL_MS     = 1500;
const WORKER_BASE = "https://whowatch-relay.win3100c.workers.dev/ww/lives/"; // 末尾 /
/* ============== */

const RAW_GIST = `https://gist.githubusercontent.com/${USER}/${GISTID}/raw/current.txt`;
const API_GIST = `https://api.github.com/gists/${GISTID}`;

const elList = document.getElementById('list');

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* ---- 安全なHTMLサニタイザ（IMG/A/BR等だけ許可） ---- */
function sanitizeMessageHTML(raw){
  // 生テキスト（HTMLなし）の場合はそのままテキスト化
  if (!/[<>&]/.test(raw)) return document.createTextNode(raw);

  const parser = new DOMParser();
  // ラップしてパース
  const doc = parser.parseFromString(`<div>${raw}</div>`, "text/html");
  const root = doc.body.firstChild;

  const allowedTags = new Set(["BR","IMG","B","I","U","STRONG","EM","A","SPAN"]);
  const allowedImgHostSuffix = [".whowatch.tv"]; // 例: img.whowatch.tv / static.whowatch.tv など
  const frag = document.createDocumentFragment();

  function isAllowedImgSrc(urlStr){
    try{
      const u = new URL(urlStr, location.href);
      if (u.protocol !== "https:") return false;
      return allowedImgHostSuffix.some(suf => u.hostname.endsWith(suf));
    }catch{ return false; }
  }

  function walk(node, outParent){
    if (node.nodeType === Node.TEXT_NODE){
      outParent.appendChild(document.createTextNode(node.nodeValue));
      return;
    }
    if (node.nodeType !== Node.ELEMENT_NODE){
      return; // コメント等は捨てる
    }

    const tag = node.tagName;
    if (!allowedTags.has(tag)){
      // 許可されていないタグは中身だけを再帰処理（タグ自体は除去）
      for (const child of [...node.childNodes]) walk(child, outParent);
      return;
    }

    if (tag === "BR"){
      outParent.appendChild(document.createElement("br"));
      return;
    }

    if (tag === "IMG"){
      const src = node.getAttribute("src") || "";
      if (!isAllowedImgSrc(src)) {
        // 許可外SRCはテキストに落とす
        outParent.appendChild(document.createTextNode(`[img blocked]`));
        return;
      }
      const img = document.createElement("img");
      img.src = src;
      // 絵文字系なら class=emoji を付与（/emoji/ を含む場合）
      if (src.includes("/emoji/")) img.className = "emoji";
      // 安全のため style/onclick 等はコピーしない
      img.referrerPolicy = "no-referrer";
      img.loading = "lazy";
      outParent.appendChild(img);
      return;
    }

    if (tag === "A"){
      const href = node.getAttribute("href") || "";
      try{
        const u = new URL(href, location.href);
        if (u.protocol !== "https:") throw 0;
        const a = document.createElement("a");
        a.href = u.href;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        // 子要素を再帰でサニタイズして入れる
        for (const child of [...node.childNodes]) walk(child, a);
        outParent.appendChild(a);
      }catch{
        // 不正URLは中身だけ残す
        for (const child of [...node.childNodes]) walk(child, outParent);
      }
      return;
    }

    // B/I/U/STRONG/EM/SPAN は属性を剝いでタグのみ許可
    const safe = document.createElement(tag.toLowerCase());
    for (const child of [...node.childNodes]) walk(child, safe);
    outParent.appendChild(safe);
  }

  for (const child of [...root.childNodes]) walk(child, frag);
  return frag;
}

/* URL→id抽出＆プロキシURL生成 */
function buildApiUrlFromSource(u){
  const s=(u||"").trim();
  let m = s.match(/^https?:\/\/api\.whowatch\.tv\/lives\/(\d+)/);
  if(!m) m = s.match(/whowatch\.tv\/(?:lives|viewer)\/(\d+)/);
  if(!m) m = s.match(/r\.whowatch\.tv\/lives\/(\d+)/);
  if(!m) return null;
  const id = m[1];
  return { id, url: `${WORKER_BASE}${id}?last_updated_at=` };
}

/* Gist読み（API優先→RAWフォールバック） */
async function readGistText(){
  try{
    const res = await fetch(API_GIST, { headers: { "Accept":"application/vnd.github+json" }, cache:"no-store" });
    if(!res.ok) throw new Error(`Gist API ${res.status}`);
    const j = await res.json();
    const f = j.files?.["current.txt"];
    if (!f) throw new Error("Gistに current.txt がありません");
    if (f.truncated === false && typeof f.content === "string") return f.content.trim();
    if (f.raw_url) {
      const r = await fetch(f.raw_url + "?t=" + Date.now(), { cache:"no-store" });
      if(!r.ok) throw new Error(`Gist RAW ${r.status}`);
      return (await r.text()).trim();
    }
    throw new Error("Gistファイルを読めません（raw_urlなし）");
  }catch(e){
    const r = await fetch(RAW_GIST + "?t=" + Date.now(), { cache:"no-store" });
    if(!r.ok) throw new Error(`Gist RAW ${r.status} / ${e.message}`);
    return (await r.text()).trim();
  }
}

/* 表示：先頭に（最新を上に） */
function prependComment(c){
  const li = document.createElement('li');

  const user = c?.user?.name ?? c?.user_name ?? "匿名";
  const ts   = typeof c?.posted_at === "number"
                ? new Date(c.posted_at).toLocaleString()
                : (c?.created_at || c?.updated_at || c?.time || "");

  const userDiv = document.createElement('div');
  userDiv.className = "user";
  userDiv.textContent = user;

  const msgDiv = document.createElement('div');
  msgDiv.className = "msg";
  const rawMsg = c?.message ?? c?.escaped_message ?? c?.text ?? c?.body ?? "";
  const safeFrag = sanitizeMessageHTML(rawMsg);
  msgDiv.appendChild(safeFrag);

  const metaDiv = document.createElement('div');
  metaDiv.className = "meta";
  metaDiv.textContent = ts;

  li.appendChild(userDiv);
  li.appendChild(msgDiv);
  li.appendChild(metaDiv);

  elList.insertBefore(li, elList.firstChild);
  // 上限件数（古い方＝末尾から削除）
  const MAX = 80;
  while (elList.childElementCount > MAX) elList.removeChild(elList.lastChild);
}

/* ===== 変換＋ポーリング ===== */
let apiUrl = "", liveId = "", lastCur = null, etag = null, seen = new Set();
function idOf(c){ return c?.id ?? `${c?.user?.id||c?.user_id||"u"}-${c?.posted_at||c?.created_at||c?.updated_at||Math.random()}`; }

async function init(){
  const txt = await readGistText();
  const first = (txt.split(/\r?\n/).map(s=>s.trim()).find(Boolean)) || "";
  const built = buildApiUrlFromSource(first);
  if (!built) throw new Error("対応外URL: " + first);
  apiUrl = built.url; liveId = built.id; lastCur = null;
}

async function pollOnce(){
  const url = apiUrl + encodeURIComponent(lastCur || "");
  const headers = {"cache-control":"no-store"}; if(etag) headers["If-None-Match"] = etag;

  const res = await fetch(url, { headers });
  if(res.status === 304) return;
  if(!res.ok) throw new Error(`WhoWatch ${res.status}`);

  etag = res.headers.get("etag") || etag;
  const json = await res.json();

  let arr = Array.isArray(json.comments) ? json.comments
          : Array.isArray(json.data)     ? json.data
          : null;
  if(!arr){
    const find = (obj, depth=0) => {
      if(depth>3 || !obj) return null;
      if(Array.isArray(obj)){
        const score = obj.slice(0,5).reduce((n,it)=> n + (it && (it.message||it.text||it.body) ? 1:0), 0);
        return score>=2 ? obj : null;
      }
      if(typeof obj === "object"){
        for(const k of Object.keys(obj)){ const f=find(obj[k], depth+1); if(f) return f; }
      }
      return null;
    };
    arr = find(json);
  }

  if(Array.isArray(arr) && arr.length){
    // 時系列に整列（古→新）
    arr.sort((a,b)=>{
      const ta = (typeof a.posted_at==="number") ? a.posted_at : +new Date(a.created_at||a.updated_at||0);
      const tb = (typeof b.posted_at==="number") ? b.posted_at : +new Date(b.created_at||b.updated_at||0);
      return ta - tb;
    });

    // 未表示分だけ順に先頭へ（結果として最新が最上段）
    for(const c of arr){
      const id = idOf(c);
      if(seen.has(id)) continue;
      seen.add(id);
      prependComment(c);
    }

    // カーソル更新
    let nextCur = json.last_updated_at || json.cursor || null;
    if(!nextCur && arr.length){
      const last = arr[arr.length-1];
      if (typeof last.posted_at === "number") nextCur = new Date(last.posted_at).toISOString();
      else {
        const t = last.created_at || last.updated_at || last.time;
        nextCur = t ? new Date(t).toISOString() : null;
      }
    }
    if(nextCur) lastCur = String(nextCur);
  }
}

async function loop(){
  while(true){
    try{ await pollOnce(); } catch(e){ /* 画面には出さない */ }
    await new Promise(r=>setTimeout(r, POLL_MS));
  }
}

(async function main(){
  try{
    await init();
    await pollOnce();
    loop();
  }catch(e){
    // 初期化失敗時はコンソールにだけ出す
    console.error(e);
  }
})();
</script>
</body>
</html>
