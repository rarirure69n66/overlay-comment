<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WhoWatch Overlay（最新のみ・増分ポーリング）</title>
<style>
  html,body{margin:0;background:#0b0b0b;color:#fff;font-family:sans-serif}
  #frame{padding:14px}
  .row{margin:6px 0;padding:10px 14px;background:rgba(0,0,0,.6);
       border-left:4px solid #ffeb66;border-radius:10px;max-width:92vw}
  .meta{opacity:.7;font-size:12px;margin-top:4px}
  #status{position:fixed;left:8px;top:8px;opacity:.7;font-size:12px}
</style>
</head>
<body>
<div id="status">初期化中…</div>
<div id="frame"><div class="row">待機中…</div></div>

<script>
/* ===== ここを差し替え ===== */
const USER   = "rarirure69n66";      // 例: rarirure69n66
const GISTID = "5697ca0fe833531c03c10ba6950f7d3e";   // 例: 1a2b3c4d5e6...
const POLL_MS = 1500;            // 取得間隔(ms)
/* ========================= */

const RAW_GIST = `https://gist.githubusercontent.com/${USER}/${GISTID}/raw/current.txt`;
const BASE_API = "https://api.whowatch.tv/lives/";
const elFrame  = document.getElementById('frame');
const elStatus = document.getElementById('status');

let liveId    = "";
let apiPrefix = "";    // https://api.whowatch.tv/lives/<id>?last_updated_at=
let lastCur   = null;  // 初回は「完全リセット」＝ null
let etag      = null;  // 任意: ETagが返れば節約に使う

function setStatus(s){ elStatus.textContent = s; }
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

function convertToApi(u){
  const s=(u||"").trim();
  let m = s.match(/^https?:\/\/api\.whowatch\.tv\/lives\/(\d+)/);
  if(m) return {id:m[1], url:`${BASE_API}${m[1]}?last_updated_at=`};
  m = s.match(/whowatch\.tv\/(?:lives|viewer)\/(\d+)/);
  if(m) return {id:m[1], url:`${BASE_API}${m[1]}?last_updated_at=`};
  m = s.match(/r\.whowatch\.tv\/lives\/(\d+)/);
  if(m) return {id:m[1], url:`${BASE_API}${m[1]}?last_updated_at=`};
  return null;
}

async function initFromGist(){
  const res = await fetch(RAW_GIST + "?t=" + Date.now(), { cache:"no-store" });
  if(!res.ok) throw new Error("Gist取得失敗 " + res.status);
  const first = (await res.text()).split(/\r?\n/).map(s=>s.trim()).find(Boolean)||"";
  const conv = convertToApi(first);
  if(!conv) throw new Error("対応外URL: " + first);
  liveId    = conv.id;
  apiPrefix = conv.url;
  // 要望：アクセス時に last_updated_at リセット（＝最初から取得）
  lastCur   = null;
  setStatus(`開始 live:${liveId} last: <全取得>`);
}

function renderLatest(c){
  const user = c?.user?.name ?? c?.user_name ?? "匿名";
  const text = c?.text ?? c?.body ?? JSON.stringify(c);
  const t    = c?.created_at || c?.updated_at || c?.time || "";
  elFrame.innerHTML = `
    <div class="row">
      <div><strong>${escapeHtml(user)}</strong>：${escapeHtml(text)}</div>
      <div class="meta">${escapeHtml(t)}</div>
    </div>`;
}

async function pollOnce(){
  const url = apiPrefix + encodeURIComponent(lastCur||"");
  const headers = {"cache-control":"no-cache"};
  if(etag) headers["If-None-Match"] = etag;

  const res = await fetch(url, { headers });
  if(res.status === 304){ setStatus(`304 Not Modified / last:${lastCur||"<全取得>"}`); return; }
  if(!res.ok) throw new Error("API " + res.status);

  etag = res.headers.get("etag") || etag;
  const json = await res.json();

  // WhoWatchの実レスポンスに合わせてここを調整（仮に comments or data に配列）
  const arr = Array.isArray(json.comments) ? json.comments : (json.data || []);
  if(Array.isArray(arr) && arr.length){
    // 古→新に整列して、最新1件だけ表示
    arr.sort((a,b)=> new Date(a.created_at||a.updated_at||0) - new Date(b.created_at||b.updated_at||0));
    const latest = arr[arr.length - 1];
    renderLatest(latest);

    // カーソル更新：APIがlast_updated_at/cursorを返すならそれを優先
    let nextCur = json.last_updated_at || json.cursor || null;
    if(!nextCur){
      const t = latest.created_at || latest.updated_at || latest.time;
      nextCur = t ? new Date(t).toISOString() : null;
    }
    if(nextCur) lastCur = String(nextCur);
  }
  setStatus(`OK live:${liveId} last:${lastCur||"<全取得>"}`);
}

async function loop(){
  while(true){
    try{
      await pollOnce();
    }catch(e){
      setStatus("ERR " + e.message);
    }
    await new Promise(r=>setTimeout(r, POLL_MS));
  }
}

(async function main(){
  try{
    await initFromGist();  // URL読み + リセット
    await pollOnce();      // まず1回（全取得の最後＝最新を表示）
    loop();                // 以後は最新だけ拾い続ける
  }catch(e){
    setStatus("初期化失敗: " + e.message);
  }
})();
</script>
</body>
</html>
