<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>WhoWatch URLâ†’APIå¤‰æ›ï¼‹æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆGitHubç‰ˆï¼‰</title>
<style>
  html,body{margin:0;padding:0;background:#0b0b0b;color:#fff;font-family:sans-serif}
  .wrap{padding:16px;max-width:900px;margin:0 auto}
  h1{font-size:18px;margin:0 0 12px}
  .small{opacity:.75;font-size:12px}
  .box{background:#111;border:1px solid #333;border-radius:10px;padding:12px;margin:10px 0;word-break:break-all}
  .label{font-size:12px;opacity:.85;margin-bottom:6px}
  .row{margin:6px 0;padding:10px 14px;background:rgba(0,0,0,.6);border-left:4px solid #ffeb66;border-radius:10px;max-width:92vw}
  .meta{opacity:.7;font-size:12px;margin-top:4px}
  .err{color:#ff8a8a;white-space:pre-wrap}
  code{background:#222;padding:2px 4px;border-radius:4px}
</style>
</head>
<body>
<div class="wrap">
  <h1>WhoWatch URLâ†’APIå¤‰æ› ï¼‹ æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆ</h1>

  <div class="box">
    <div class="label">Gist</div>
    <div class="small">API: <span id="gist-api"></span></div>
    <div class="small">RAW: <span id="gist-raw"></span></div>
  </div>

  <div class="box">
    <div class="label">Gistå†…ã®å…ƒURLï¼ˆè¤‡æ•°è¡ŒOKï¼å…ˆé ­ã‚’ä½¿ç”¨ï¼‰</div>
    <div id="raw" class="small">(èª­è¾¼ä¸­)</div>
  </div>

  <div class="box">
    <div class="label">å¤‰æ›çµæœï¼ˆAPI URL or ãƒ—ãƒ­ã‚­ã‚·URLï¼‰</div>
    <div id="converted" class="small"></div>
  </div>

  <div class="box">
    <div class="label">æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯ãƒªã‚»ãƒƒãƒˆï¼æœ€åˆã‹ã‚‰å–å¾—â†’ä»¥å¾Œã¯å¢—åˆ†ï¼‰</div>
    <div id="latest" class="row">å¾…æ©Ÿä¸­â€¦</div>
    <div id="status" class="small"></div>
  </div>

  <div id="err" class="err"></div>

  <div class="box small">
    <div class="label">ãƒ¡ãƒ¢</div>
    <div>
      WhoWatch APIãŒãƒ–ãƒ©ã‚¦ã‚¶ã®CORSã‚’è¨±å¯ã—ã¦ã„ãªã„å ´åˆã€ã“ã“ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚  
      ãã®ã¨ãã¯æ¬¡ã®æ®µéšã§ã€Œä¸­ç¶™URLï¼ˆWORKER_BASEï¼‰ã€ã‚’å…¥ã‚Œã‚‹ã¨å‹•ä½œã—ã¾ã™ã€‚
    </div>
  </div>
</div>

<script>
/* ====== è¨­å®šï¼ˆã‚ãªãŸã®å€¤ï¼‰====== */
const USER   = "rarirure69n66";
const GISTID = "5697ca0fe833531c03c10ba6950f7d3e";
const POLL_MS = 1500;
/* â€”â€” å¾Œã§ä¸­ç¶™(Cloudflare Workersç­‰)ã‚’ä½œã£ãŸã‚‰ã“ã“ã«ãƒ™ãƒ¼ã‚¹URLã‚’å…¥ã‚Œã‚‹ â€”â€” */
const WORKER_BASE = "https://whowatch-relay.win3100c.workers.dev/ww/lives/"; // â†æœ«å°¾ã® / ã‚’å¿˜ã‚Œãšã«
/* ================================== */

const RAW_GIST = `https://gist.githubusercontent.com/${USER}/${GISTID}/raw/current.txt`;
const API_GIST = `https://api.github.com/gists/${GISTID}`;
document.getElementById('gist-api').textContent = API_GIST;
document.getElementById('gist-raw').textContent = RAW_GIST;

const elErr = document.getElementById('err');
const elRaw = document.getElementById('raw');
const elConv = document.getElementById('converted');
const elLatest = document.getElementById('latest');
const elStatus = document.getElementById('status');

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function setStatus(msg){ elStatus.textContent = msg; }

// URLâ†’idæŠ½å‡ºï¼†API/ãƒ—ãƒ­ã‚­ã‚·URLç”Ÿæˆ
function buildApiUrlFromSource(u){
  const s=(u||"").trim();
  let m = s.match(/^https?:\/\/api\.whowatch\.tv\/lives\/(\d+)/);
  if(!m) m = s.match(/whowatch\.tv\/(?:lives|viewer)\/(\d+)/);
  if(!m) m = s.match(/r\.whowatch\.tv\/lives\/(\d+)/);
  if(!m) return null;
  const id = m[1];
  if (WORKER_BASE) {
    // ä¸­ç¶™ã‚’ä½¿ã†ï¼ˆCORSå›é¿ï¼‰
    return { id, url: `${WORKER_BASE}${id}?last_updated_at=` };
  } else {
    // ç›´æ¥WhoWatchã¸ï¼ˆCORSã§å¤±æ•—ã™ã‚‹å ´åˆã‚ã‚Šï¼‰
    return { id, url: `https://api.whowatch.tv/lives/${id}?last_updated_at=` };
  }
}

// Gistèª­ã¿ï¼ˆAPIå„ªå…ˆâ†’RAWãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
async function readGistText(){
  try{
    // ğŸ‘‡ ãƒ˜ãƒƒãƒ€ã¯ Accept ã ã‘ã€‚Cache-Control ã¯ä»˜ã‘ãªã„
    const res = await fetch(API_GIST, {
      headers: { "Accept":"application/vnd.github+json" },
      cache: "no-store"     // â† ã“ã£ã¡ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
    });
    if(!res.ok) throw new Error(`Gist API ${res.status}`);
    const j = await res.json();
    const f = j.files?.["current.txt"];
    if (!f) throw new Error("Gistã« current.txt ãŒã‚ã‚Šã¾ã›ã‚“");

    if (f.truncated === false && typeof f.content === "string") {
      return f.content.trim();
    }
    if (f.raw_url) {
      const r = await fetch(f.raw_url + "?t=" + Date.now(), { cache:"no-store" });
      if(!r.ok) throw new Error(`Gist RAW ${r.status}`);
      return (await r.text()).trim();
    }
    throw new Error("Gistãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚ã¾ã›ã‚“ï¼ˆraw_urlãªã—ï¼‰");
  }catch(e){
    // RAWãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã“ã£ã¡ã¯ãã®ã¾ã¾ã§OKï¼‰
    try{
      const r = await fetch(RAW_GIST + "?t=" + Date.now(), { cache:"no-store" });
      if(!r.ok) throw new Error(`Gist RAW ${r.status}`);
      return (await r.text()).trim();
    }catch(e2){
      throw new Error(`Gistå–å¾—å¤±æ•—: ${e.message} / ${e2.message}`);
    }
  }
}


function showLatest(c){
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
  const user = c?.user?.name ?? c?.user_name ?? "åŒ¿å";

  // æœ¬æ–‡ï¼ˆWhoWatchã¯ message / escaped_message ã‚’å„ªå…ˆï¼‰
  const msg = c?.message ?? c?.escaped_message ?? c?.text ?? c?.body ?? "(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)";

  // æ™‚åˆ»ï¼ˆposted_at ã¯ãƒŸãƒªç§’ã‚¨ãƒãƒƒã‚¯ï¼‰
  let t = "";
  if (typeof c?.posted_at === "number") {
    t = new Date(c.posted_at).toLocaleString();       // ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã§è¡¨ç¤º
  } else {
    t = c?.created_at || c?.updated_at || c?.time || "";
  }

  elLatest.innerHTML =
    `<div><strong>${escapeHtml(user)}</strong>ï¼š${escapeHtml(msg)}</div>` +
    `<div class="meta">${escapeHtml(t)}</div>`;
}


// ===== å¤‰æ›ï¼‹ãƒãƒ¼ãƒªãƒ³ã‚° =====
let apiUrl = "";
let liveId = "";
let lastCur = null;
let etag   = null;

async function init(){
  elErr.textContent = "";
  setStatus("åˆæœŸåŒ–ä¸­â€¦");

  const txt = await readGistText();
  elRaw.textContent = txt || "(ç©ºã§ã™)";
  const first = (txt.split(/\r?\n/).map(s=>s.trim()).find(Boolean)) || "";
  const built = buildApiUrlFromSource(first);
  if (!built) throw new Error("å¯¾å¿œå¤–URL: " + first);

  apiUrl = built.url;
  liveId = built.id;

  elConv.textContent = apiUrl;
  lastCur = null; // ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰
  setStatus(`é–‹å§‹ live:${liveId} last:<å…¨å–å¾—>`);
}

async function pollOnce(){
  const url = apiUrl + encodeURIComponent(lastCur || "");
  const headers = {"cache-control":"no-cache"};
  if(etag) headers["If-None-Match"] = etag;

  const res = await fetch(url, { headers });
  if(res.status === 304){ setStatus(`304 Not Modified / last:${lastCur||"<å…¨å–å¾—>"}`); return; }
  if(!res.ok) throw new Error(`WhoWatch ${res.status}`);
  etag = res.headers.get("etag") || etag;
  const json = await res.json();

  const arr = Array.isArray(json.comments) ? json.comments : (json.data || []);
  if(Array.isArray(arr) && arr.length){
    arr.sort((a,b)=> new Date(a.created_at||a.updated_at||0) - new Date(b.created_at||b.updated_at||0));
    const latest = arr[arr.length - 1];
    
    showLatest(latest);
    
    // ã‚«ãƒ¼ã‚½ãƒ«æ›´æ–°ï¼ˆAPIãŒè¿”ã™ã‚‚ã®ã‚’å„ªå…ˆï¼‰
    let nextCur = json.last_updated_at || json.cursor || null;
    if (!nextCur) {
      if (typeof latest.posted_at === "number") {
        nextCur = new Date(latest.posted_at).toISOString();   // posted_at(ms) â†’ ISO
      } else {
        const t = latest.created_at || latest.updated_at || latest.time;
        nextCur = t ? new Date(t).toISOString() : null;
      }
    }
    if (nextCur) lastCur = String(nextCur);
  }
  
  setStatus(`OK live:${liveId} last:${lastCur||"<å…¨å–å¾—>"}`);
}

async function loop(){
  while(true){
    try{ await pollOnce(); }
    catch(e){
      // å…¸å‹ï¼šCORSã§å¤±æ•—ï¼ˆTypeError: Failed to fetchï¼‰
      elErr.textContent = `pollå¤±æ•—: ${e.message}\n` +
        (WORKER_BASE ? "" :
          "â†’ å¤šãã®å ´åˆã¯CORSãŒåŸå› ã§ã™ã€‚å¾Œã§ WORKER_BASE ã«ä¸­ç¶™URLã‚’å…¥ã‚Œã‚‹ã¨è§£æ±ºã—ã¾ã™ã€‚");
      setStatus("å–å¾—åœæ­¢ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰");
      break; // ç›´æ¥å–å¾—ã¯ä¸€æ—¦åœæ­¢
    }
    await new Promise(r=>setTimeout(r, POLL_MS));
  }
}

(async function main(){
  try{
    await init();
    await pollOnce();
    loop();
  }catch(e){
    elErr.textContent = `åˆæœŸåŒ–å¤±æ•—: ${e.message}`;
    setStatus("åˆæœŸåŒ–å¤±æ•—");
  }
})();
</script>
</body>
</html>


